<!DOCTYPE html><html lang="ro"><head><meta charset="utf-8">
<title>Calculator Comision</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
<style>
 body{font-family:sans-serif;background:#f6f8fa;padding:18px}
 h1{margin:0 0 12px;color:#2e7d32}
 input,select,button{padding:6px 8px;margin:3px;font-size:.88rem}
 table{width:100%;border-collapse:collapse;margin-top:14px;background:#fff;font-size:.85rem}
 th,td{border:1px solid #ccc;padding:6px} th{background:#4caf50;color:#fff}
 .right{text-align:right} button{border:0;border-radius:3px;cursor:pointer}
 .g{background:#2e7d32;color:#fff}.y{background:#ffc107}.b{background:#0d6efd;color:#fff}.r{background:#d32f2f;color:#fff}
</style>
<!-- SheetJS pentru XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
<!-- jsPDF pentru PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>
</head><body>

<h1>Calculator Comision</h1>

<input id="agent" placeholder="Nume agent">
<input id="luna"  placeholder="Luna (AAAA-LL)"><br>

<input id="nume" placeholder="Nume client">
<input id="suma" placeholder="Suma">
<select id="banca">
 <option>BCR</option><option>BRD</option><option>ING</option><option>UNICREDIT</option>
 <option>GARANTI</option><option>FIRST BANK</option><option>ALPHA</option>
 <option>RAIFFEISEN</option><option>PATRIA</option><option>LIBRA</option><option>CREDIT EUROPE</option>
</select>
<select id="tip"><option>IP</option><option>REF IP</option><option>NP</option><option>REF NP</option></select>
<select id="prov">
 <option>RECOMANDARI</option><option>TEOCREDIT</option><option>TCC - ADAMA</option>
 <option>TCC - WHITE POINT</option><option>AGENT - DAF IMOBILIARE</option><option>AGENT - BEE IMOBILIARE</option>
</select>
<button class="g" onclick="addRow()">Adaugă credit</button>
<button class="y" onclick="calc()">Calculează</button><br>

<input type="file" id="csv" accept=".csv">
<button class="b" onclick="loadCSV()">Încarcă CSV</button>
<button class="y" onclick="exportPDF()">Exportă PDF</button>
<button class="g" onclick="exportXLSX()">Exportă XLSX</button>
<button class="g" onclick="exportCSV()">Exportă CSV</button>
<button class="g" onclick="exportHTMLxls()">Exportă XLS (HTML)</button>

<table id="tbl"><thead><tr>
 <th>#</th><th>Nume</th><th>Banca</th><th>Tip</th><th>Suma</th>
 <th>Provider</th><th>Proc.</th><th>Comision</th><th></th></tr></thead>
 <tbody></tbody>
 <tfoot><tr><td colspan="7" class="right"><b>Total castig</b></td><td id="tot">0</td><td></td></tr></tfoot>
</table>
<div id="rez" style="margin-top:12px;font-size:.85rem"></div>

<script>
const GRILA_IP={BCR:[[0,.008],[800001,.009],[1600001,.010],[2400001,.012],[5000001,.014],[5e7,.018]],
PATRIA:[[0,.008],[800001,.010],[1600001,.012],[2400001,.014]],
ALPHA:[[0,.008],[800001,.009],[1600001,.010]],
ING:[[0,.008],[1600001,.009]],UNICREDIT:[[0,.008],[800001,.009]],
RAIFFEISEN:[[0,.008],[800001,.009]],"CREDIT EUROPE":[[0,.008],[800001,.011]],
BT:[[0,.008]],BRD:[[0,.008]],GARANTI:[[0,.008]],"FIRST BANK":[[0,.008]],LIBRA:[[0,.008]]};

const NP_CAT1={PATRIA:1.2,UNICREDIT:2,"FIRST BANK":2,GARANTI:1.2,ING:.4};
const NP_CAT2={PATRIA:1,UNICREDIT:1,"FIRST BANK":1,GARANTI:1,ING:.4};
const CAT2_IP=.004;

const rows=[]; const $=id=>document.getElementById(id);
const num=(s)=>parseFloat((s||'').replace(/[ .]/g,'').replace(',','.'))||0;
const fmt=n=>n.toLocaleString('ro-RO',{minimumFractionDigits:2,maximumFractionDigits:2});
const cat=p=>/^AGENT/.test(p)?3:(/^TCC|TEOCREDIT/.test(p)?2:1);

function procIP(b,s,c){let p=(GRILA_IP[b]||[[0,.008]])[0][1];
(GRILA_IP[b]||[]).forEach(([m,x])=>{if(s>=m)p=x});return c===3?p/2:p}
function procNP(b,c){return c===3?0:(c===2?(NP_CAT2[b]||0):(NP_CAT1[b]||0))}

function addRow(){
  const s=num($('suma').value); if(!s)return alert('Sumă?');
  rows.push({nume:$('nume').value||'N/A',banca:$('banca').value,
             tip:$('tip').value.toUpperCase(),suma:s,prov:$('prov').value.toUpperCase()});
  $('nume').value='';$('suma').value=''; calc();
}
function delRow(i){rows.splice(i,1);calc();}

function loadCSV(){
  const f=$('csv').files[0]; if(!f)return; f.text().then(t=>{
    t.split(/\r?\n/).forEach(l=>{
      const[a,b,c,d,e]=l.split(','); const s=num(d); if(!b||!s)return;
      rows.push({nume:a||'N/A',banca:b.trim().toUpperCase(),
                 tip:(c||'IP').trim().toUpperCase(),suma:s,
                 prov:(e||'RECOMANDARI').trim().toUpperCase()});
    }); calc();
  });
}

function calc(){
  const sumIP={}; rows.forEach(r=>{if(r.tip.includes('IP')&&cat(r.prov)!==2)sumIP[r.banca]=(sumIP[r.banca]||0)+r.suma});
  let tot=0;
  rows.forEach(r=>{
    const c=cat(r.prov);
    r.pr=r.tip.includes('NP')?procNP(r.banca,c):(c===2?CAT2_IP:procIP(r.banca,sumIP[r.banca]||0,c));
    r.com=r.suma*r.pr; tot+=r.com;
  }); render(tot);
  $('rez').innerHTML=Object.entries(sumIP).map(([b,s])=>`<b>${b}</b>: total Cat1+3 = ${s.toLocaleString()} RON → prag ${(procIP(b,s,1)*100).toFixed(2)}%`).join('<br>');
}

function render(t){
 const tb=$('tbl').tBodies[0]; tb.innerHTML='';
 rows.forEach((r,i)=>tb.insertAdjacentHTML('beforeend',`<tr>
 <td>${i+1}</td><td>${r.nume}</td><td>${r.banca}</td><td>${r.tip}</td>
 <td class=right>${fmt(r.suma)}</td><td>${r.prov}</td>
 <td class=right>${(r.pr*100).toFixed(2)}%</td><td class=right>${fmt(r.com)}</td>
 <td><button class="r" onclick="delRow(${i})">x</button></td></tr>`));
 $('tot').textContent=fmt(t);
}

/* ---- Exporturi ---- */
function exportCSV(){
 if(!rows.length)return alert('Nu există date!');
 const list=[`Agent,${$('agent').value||'-'}`,`Luna,${$('luna').value||'-'}`,'',
 'Nume,Banca,Tip,Suma,Provider,Proc,Comision'];
 rows.forEach(r=>list.push([`"${r.nume}"`,r.banca,r.tip,r.suma,r.prov,(r.pr*100).toFixed(2)+'%',r.com.toFixed(2)].join(',')));
 list.push('',`,,Total_castig,${$('tot').textContent.replace(/[^\d.,]/g,'').replace(',','.')}`);
 download(new Blob([list.join('\r\n')],{type:'text/csv;charset=utf-8'}),'borderou.csv');
}
function exportHTMLxls(){
 if(!rows.length)return alert('Nu există date!');
 const lines=rows.map(r=>`<tr><td>${r.nume}</td><td>${r.banca}</td><td>${r.tip}</td><td>${r.suma}</td><td>${r.prov}</td><td>${(r.pr*100).toFixed(2)}%</td><td>${r.com.toFixed(2)}</td></tr>`).join('');
 const html=`<html><meta charset=utf-8><body>
 <table border=1><tr><td>Agent</td><td>${$('agent').value||'-'}</td></tr><tr><td>Luna</td><td>${$('luna').value||'-'}</td></tr></table><br>
 <table border=1><tr><th>Nume</th><th>Banca</th><th>Tip</th><th>Suma</th><th>Provider</th><th>Proc</th><th>Comision</th></tr>
 ${lines}<tr><td colspan=6><b>Total_castig</b></td><td>${$('tot').textContent.replace(/[^\d.,]/g,'').replace(',','.')}</td></tr></table></body></html>`;
 download(new Blob([html],{type:'application/vnd.ms-excel'}),'borderou.xls');
}
function exportXLSX(){
 if(typeof XLSX==='undefined')return alert('SheetJS nu s-a încărcat – foloseşte CSV/XLS.');
 if(!rows.length)return alert('Nu există date!');
 const ws=XLSX.utils.aoa_to_sheet([
  ['Agent',$('agent').value||'-'],['Luna',$('luna').value||'-'],[],
  ['Nume','Banca','Tip','Suma','Provider','Proc','Comision'],
  ...rows.map(r=>[r.nume,r.banca,r.tip,r.suma,r.prov,(r.pr*100).toFixed(2)+'%',+r.com.toFixed(2)]),
  [],['','', 'Total_castig', $('tot').textContent.replace(/[^\d.,]/g,'').replace(',','.')]
 ]);
 const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Borderou');XLSX.writeFile(wb,'borderou.xlsx');
}
function exportPDF(){
 if(!rows.length)return alert('Nu există date!');
 const {jsPDF}=window.jspdf;const doc=new jsPDF();
 doc.text(`Agent: ${$('agent').value||'-'}  •  Luna: ${$('luna').value||'-'}`,14,16);
 doc.autoTable({head:[['Nume','Banca','Tip','Suma','Provider','Proc','Comision']],
  body:rows.map(r=>[r.nume,r.banca,r.tip,fmt(r.suma),r.prov,(r.pr*100).toFixed(2)+'%',fmt(r.com)]),
  startY:22,styles:{fontSize:8}});
 doc.text(`Total castig: ${$('tot').textContent}`,14,doc.lastAutoTable.finalY+10); doc.save('borderou.pdf');
}
function download(blob,name){const u=URL.createObjectURL(blob);const a=document.createElement('a');a.href=u;a.download=name;a.click();URL.revokeObjectURL(u)}
</script>
</body></html>
