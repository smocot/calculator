<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="utf-8">
<title>Calculator Comision</title>
<style>
 body{font-family:sans-serif;margin:0 8px}
 table{width:100%;border-collapse:collapse;margin-top:6px}
 th,td{border:1px solid #3b7a33;padding:4px 6px;font-size:14px}
 th{background:#3b7a33;color:#fff;text-align:left}
 tr:nth-child(even){background:#f4fff4}
 button,select,input[type=number]{font:inherit;padding:3px 6px;margin:2px}
 .danger{background:#c00;color:#fff;border:none;padding:2px 6px;cursor:pointer}
 .small{font-size:12px;white-space:nowrap}
</style>
</head>
<body>

<div style="display:flex;flex-wrap:wrap;gap:4px;align-items:center">
  <input placeholder="Nume agent" id="agent">
  <input placeholder="Luna (AAAA-LL)" id="luna">
  <input placeholder="Nume client" id="client">
  <label class="small">Choose File
    <input id="csv" type="file" accept=".csv" style="display:none">
  </label>
  <button onclick="loadCSV()">Încarcă CSV</button>
  <button onclick="exportCSV()">Exportă CSV</button>
  <button onclick="exportXLSX()">Exportă XLSX</button>
  <!-- câmpuri pt adăugare manuală -->
  <input type="number" id="suma" placeholder="Suma" style="width:90px">
  <select id="banca">
     <option>BCR</option><option>BRD</option><option>ING</option><option>UNICREDIT</option>
     <option>GARANTI</option><option>FIRST BANK</option><option>ALPHA</option>
     <option>RAIFFEISEN</option><option>FIRST BANK</option>
  </select>
  <select id="tip"><option>IP</option><option>REF IP</option><option>NP</option><option>REF NP</option></select>
  <select id="prov">
    <option>RECOMANDARI</option>
    <option>TEOCREDIT</option>
    <option>AGENT - DAF IMOBILIARE</option>
    <option>TCC - ADAMA</option>
  </select>
  <button onclick="addRow()">Adaugă credit</button>
  <button style="background:orange" onclick="recalc()">Calculează</button>
</div>

<table id="tbl">
  <thead><tr>
   <th>#</th><th>Nume</th><th>Banca</th><th>Tip</th><th>Suma</th>
   <th>Provider</th><th>Proc.</th><th>Comision</th><th></th>
  </tr></thead>
  <tbody></tbody>
  <tfoot><tr><td colspan="7" style="text-align:right;font-weight:bold">Total câștig</td>
           <td id="tot" style="font-weight:bold"></td><td></td></tr></tfoot>
</table>

<pre id="rez" style="font-size:13px"></pre>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
<script>
const rows=[];
const clean=s=>String(s||"").replace(/['"[\]]/g,"").trim();

/* praguri Cat1 & Cat3 (Ipotecar) - doar fragmentele relevante) */
const PRAG_IP={
 BCR:[0.008,0.009,0.010,0.012,0.014,0.018],            // praguri crescătoare
 ING:[0.008,0.009],
 RAIFFEISEN:[0.008,0.009],
 UNICREDIT:[0.008,0.009],
 // … restul băncilor
};
/* Nevoi Personale – tabel fix per bancă (Cat1) */
const NP_CAT1={PATRIA:0.012, UNICREDIT:0.02, FIRST:0.02, GARANTI:0.012, ING:0.004};
/* Cat2 fix */
const FIX_CAT2={IP:0.004, NP:0.01};   // IP=0.4%,  NP =1%
/* helper: întoarce procent comision */
function pct(row,totalCat13){
 const B=row.banca.toUpperCase();
 const isNP=row.tip.startsWith('N');
 const cat = row.prov.startsWith('TEOCREDIT')||row.prov.startsWith('TCC')?2:
             row.prov.startsWith('AGENT')?3:1;
 if(cat===2) return isNP?FIX_CAT2.NP:FIX_CAT2.IP;
 if(isNP){             // Cat1 NP
    return NP_CAT1[B]??0;
 }
 // Ipotecar / Ref ipotecar
 const prag=PRAG_IP[B]||[0.008];
 let p=prag[0];
 if(totalCat13>50000000) p=prag[5]||p;
 else if(totalCat13>5000000) p=prag[4]||p;
 else if(totalCat13>2400000) p=prag[3]||p;
 else if(totalCat13>1600000) p=prag[2]||p;
 else if(totalCat13>800000) p=prag[1]||p;
 return cat===3 ? p/2 : p;          // Cat3 jumătate din Cat1
}

function render(){
 const tb=document.querySelector('#tbl tbody');
 tb.innerHTML='';
 let tot=0;
 rows.forEach((r,i)=>{
   const tr=tb.insertRow();
   tr.innerHTML=`<td>${i+1}</td><td>${r.nume}</td><td>${r.banca}</td>
     <td>${r.tip}</td><td>${r.suma.toLocaleString()}</td><td>${r.prov}</td>
     <td>${(r.proc*100).toFixed(2)}%</td><td>${r.com? r.com.toLocaleString('ro-RO',{minimumFractionDigits:2})+' RON':''}</td>
     <td><button class="danger" onclick="del(${i})">x</button></td>`;
   tot+=r.com||0;
 });
 document.getElementById('tot').textContent=tot.toLocaleString('ro-RO',{minimumFractionDigits:2});
}

function del(i){rows.splice(i,1);render();}

function addRow(){
 const s=parseFloat(document.getElementById('suma').value||0);
 if(!s) return;
 rows.push({
   nume: clean(document.getElementById('client').value)||'N/A',
   banca: document.getElementById('banca').value,
   tip:   document.getElementById('tip').value,
   suma:  s,
   prov:  document.getElementById('prov').value
 });
 render();
}

function recalc(){
 // total Cat1+3 per bancă
 const totals={};
 rows.forEach(r=>{
   const cat = r.prov.startsWith('TEOCREDIT')||r.prov.startsWith('TCC')?2:
               r.prov.startsWith('AGENT')?3:1;
   if(cat!==2){
      totals[r.banca]=(totals[r.banca]||0)+r.suma;
   }
 });
 rows.forEach(r=>{
   r.proc=pct(r,totals[r.banca]||0);
   r.com = +(r.suma*r.proc).toFixed(2);
 });
 // rezumat
 let txt='';
 for(const b in totals){
   txt+=`${b}: total Cat1+3 = ${totals[b].toLocaleString()} RON → prag ${(pct({banca:b,tip:'IP',prov:'Recomandari'},totals[b])*100).toFixed(2)}%\n`;
 }
 document.getElementById('rez').textContent=txt;
 render();
}

/* ============ CSV I/O ============== */
function loadCSV(){
 const f=document.getElementById('csv').files[0]; if(!f) return;
 f.text().then(t=>{
   rows.length=0;
   t.trim().split(/\r?\n/).forEach(l=>{
     const[x1,x2,x3,x4,x5]=l.split(',');
     if(+x4){
       rows.push({
         nume:clean(x1)||'N/A',
         banca:clean(x2),
         tip:clean(x3),
         suma:+clean(x4),
         prov:clean(x5)
       });
     }
   });
   recalc();
 });
}

function exportCSV(){
 let out='Nume,Banca,Tip,Suma,Provider\n';
 rows.forEach(r=>out+=`${r.nume},${r.banca},${r.tip},${r.suma},${r.prov}\n`);
 const blob=new Blob([out],{type:'text/csv;charset=utf-8'});
 const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(blob),download:'borderou.csv'});
 a.click();
}

function exportXLSX(){
 if(typeof XLSX==='undefined'){alert('SheetJS nu s-a încărcat');return;}
 const ws=XLSX.utils.json_to_sheet(rows.map(r=>({
   Nume:r.nume,Banca:r.banca,Tip:r.tip,Suma:r.suma,Provider:r.prov,
   Proc:(r.proc*100).toFixed(2)+'%',Comision:r.com
 })));
 const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Comisioane');
 XLSX.writeFile(wb,'borderou.xlsx');
}

/* init */
render();
</script>
</body>
</html>
