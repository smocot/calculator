<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<title>Calculator Comision</title>
<style>
 body{font-family:sans-serif;margin:0;padding:1rem;background:#f5f7f9}
 h2{color:#2e7d32;margin:0 0 .5rem}
 input,select,button{padding:.35rem .5rem;margin:.25rem}
 table{width:100%;border-collapse:collapse;margin-top:1rem;background:#fff}
 th,td{border:1px solid #ccc;padding:.4rem .5rem;font-size:.85rem}
 th{background:#4caf50;color:#fff}
 .right{text-align:right}
 .btn{cursor:pointer;border:none;border-radius:3px}
 .ok{background:#2e7d32;color:#fff}
 .warn{background:#ffc107;color:#000}
 .blue{background:#1976d2;color:#fff}
 .del{background:#e53935;color:#fff}
</style>
</head>
<body>

<h2>Calculator Comision</h2>

<!-- date agent / lună (doar pt PDF/XLSX) -->
<input id="agent" placeholder="Nume agent">
<input id="luna"  placeholder="Luna (AAAA-LL)">

<br>

<input id="nume" placeholder="Nume client">
<select id="banca">
  <option>BCR</option><option>BRD</option><option>ING</option><option>UNICREDIT</option>
  <option>GARANTI</option><option>FIRST BANK</option><option>ALPHA</option><option>RAIFFEISEN</option>
  <option>PATRIA</option><option>LIBRA</option><option>CREDIT EUROPE</option>
</select>
<select id="tip">
  <option>IP</option><option>REF IP</option>
  <option>NP</option><option>REF NP</option>
</select>
<input id="suma" type="number" placeholder="Suma">
<select id="prov">
  <option>RECOMANDARI</option>
  <option>TEOCREDIT</option>
  <option>AGENT - DAF IMOBILIARE</option>
  <option>AGENT - BEE IMOBILIARE</option>
  <option>TCC - ADAMA</option>
  <option>TCC - WHITE POINT</option>
  <option>TCC - ZONA DE NORD</option>
</select>
<button class="btn ok"   onclick="addRow()">Adaugă credit</button>
<button class="btn warn" onclick="calc()">Calculează</button>
<br>

<input type="file" id="csv"   style="margin-left:.25rem">
<button class="btn blue" onclick="loadCSV()">Încarcă CSV</button>
<button class="btn warn" onclick="exportPDF()">Exportă PDF</button>
<button class="btn ok"   onclick="exportXLSX()">Exportă XLSX</button>
<small>(Agent &amp; lună apar doar în PDF / XLSX)</small>

<table id="tbl">
  <thead>
    <tr><th>#</th><th>Nume</th><th>Banca</th><th>Tip</th><th>Suma</th>
        <th>Provider</th><th>Proc.</th><th>Comision</th><th></th></tr>
  </thead><tbody></tbody>
  <tfoot><tr>
    <td colspan="7" class="right"><strong>Total castig</strong></td>
    <td id="tot"></td><td></td></tr></tfoot>
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
/* praguri IP (Cat 1 & 3) */
const GRILA={
 "BCR":[{m:0,M:8e5,p:.008},{m:8e5+1,M:1.6e6,p:.009},
        {m:1.6e6+1,M:2.4e6,p:.01},{m:2.4e6+1,M:5e6,p:.012},
        {m:5e6+1,M:5e7,p:.014},{m:5e7+1,M:1e12,p:.018}],
 "PATRIA":[{m:0,M:8e5,p:.008},{m:8e5+1,M:1.6e6,p:.01},
           {m:1.6e6+1,M:2.4e6,p:.012},{m:2.4e6+1,M:1e12,p:.014}],
 "ALPHA":[{m:0,M:8e5,p:.008},{m:8e5+1,M:1.6e6,p:.009},{m:1.6e6+1,M:1e12,p:.01}],
 "ING":[{m:0,M:1.6e6,p:.008},{m:1.6e6+1,M:1e12,p:.009}],
 "UNICREDIT":[{m:0,M:8e5,p:.008},{m:8e5+1,M:1e12,p:.009}],
 "RAIFFEISEN":[{m:0,M:8e5,p:.008},{m:8e5+1,M:1e12,p:.009}],
 "CREDIT EUROPE":[{m:0,M:8e5,p:.008},{m:8e5+1,M:1e12,p:.011}],
 /* flat 0.8% */
 "BT":[{m:0,M:1e12,p:.008}], "BRD":[{m:0,M:1e12,p:.008}],
 "GARANTI":[{m:0,M:1e12,p:.008}], "FIRST BANK":[{m:0,M:1e12,p:.008}],
 "LIBRA":[{m:0,M:1e12,p:.008}]
};
/* procente NP fixe (Cat1 / Cat2), Cat3 = 0 */
const NP={
 "UNICREDIT":{c1:.02,c2:.01},
 "PATRIA":   {c1:.012,c2:.01},
 "FIRST BANK":{c1:.02,c2:.01},
 "GARANTI":  {c1:.012,c2:.01},
 "ING":      {c1:.004,c2:.004}
};

let rows=[];

/* helpers */
const $=id=>document.getElementById(id);
function clean(t){return t.replace(/^\s*["'\[]+|\s*["'\]]+\s*$/g,'').trim();}
function category(p){return p.startsWith('AGENT')?3:(p.startsWith('TCC')||p==='TEOCREDIT'?2:1);}
/* procent in funcţie de bancă, tip, sumă, categorie */
function proc(b,tip,sum,ct){
 if(['NP','REF NP'].includes(tip)){
   const r=NP[b]||{};
   if(ct===3) return 0;
   return ct===2?(r.c2||0):(r.c1||0);
 }
 /* Cat2 IP/REF IP = 0.4 indiferent de bancă */
 if(ct===2) return .004;
 const band=GRILA[b]||[{m:0,M:1e12,p:.008}];
 const r=band.find(o=>sum>=o.m && sum<=o.M) || {p:0};
 return ct===3? r.p/2 : r.p;
}

function addRow(){
 const n= $('nume').value||'N/A';
 const b= $('banca').value;
 const t= $('tip').value;
 const s= +$('suma').value||0;
 const p= $('prov').value;
 if(!s){alert('Introduceţi sumă!');return}
 rows.push({n,b,t,s,p});
 render();calc();
 ['nume','suma'].forEach(i=>$(i).value='');
}

function render(){
 const tb=document.querySelector('#tbl tbody');tb.innerHTML='';
 rows.forEach((r,i)=>{
   const tr=tb.insertRow(); const ct=category(r.p);
   const pr=proc(r.b,r.t,sumCat(r.b,ct,r.t),ct); r.pr=pr;
   r.c=r.s*pr;
   tr.innerHTML=`<td>${i+1}</td><td>${r.n}</td><td>${r.b}</td>
   <td>${r.t}</td><td class=right>${fmt(r.s)}</td><td>${r.p}</td>
   <td class=right>${(pr*100).toFixed(2)}%</td>
   <td class=right>${fmt(r.c)} RON</td>
   <td><button class="btn del" onclick="delRow(${i})">Şterge</button></td>`;
 });
}

function sumCat(b,ct,tip){
 return rows.filter(x=>x.b===b && category(x.p)===ct && !['NP','REF NP'].includes(x.tip?x.tip:tip)).reduce((a,c)=>a+c.s,0);
}

function calc(){
 let tot=0, rez='';
 const banci=[...new Set(rows.map(r=>r.b))];
 banci.forEach(b=>{
  let txt=`${b}: `;
  const cat1=sumCat(b,1);
  const cat3=sumCat(b,3);
  const tot13=cat1+cat3;
  const prCat1=proc(b,'IP',tot13,1);
  txt+=`total Cat1+3 = ${fmt(tot13)} RON → prag = ${(prCat1*100).toFixed(2)}%`;
  rez+=txt+'\n';
 });
 rows.forEach(r=>tot+=r.c);
 $('tot').textContent=fmt(tot)+' RON';
}
function delRow(i){rows.splice(i,1);render();calc();}
function fmt(x){return x.toLocaleString('ro-RO')}

function loadCSV(){
 const f=$('csv').files[0]; if(!f) return;
 f.text().then(t=>{
  t.split(/\r?\n/).forEach(l=>{
    if(!l.trim())return;
    const[a,b,c,d,e]=l.split(',');
    if(b&&d&&!isNaN(+d)) rows.push({
      n:clean(a)||'N/A', b:clean(b), t:clean(c), s:+clean(d), p:clean(e)
    });
  });
  render();calc();
 });
}

async function exportPDF(){
 const {jsPDF}=window.jspdf; const doc=new jsPDF({orientation:'l',unit:'pt',format:'a4'});
 doc.text(`Agent: ${$('agent').value||'-'}   Luna: ${$('luna').value||'-'}`,40,30);
 let y=60; doc.autoTable({html:'#tbl',startY:y,theme:'grid'});
 doc.save('borderou.pdf');
}

function exportXLSX(){
 const ws=XLSX.utils.json_to_sheet(rows.map(r=>({
  Nume:r.n,Banca:r.b,Tip:r.t,Suma:r.s,Provider:r.p,Proc:(r.pr*100).toFixed(2)+'%',Comision:r.c
 })));
 const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Borderou');
 XLSX.writeFile(wb,'borderou.xlsx');
}
</script>
</body>
</html>
