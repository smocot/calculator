<!DOCTYPE html><html lang="ro"><head><meta charset="utf-8">
<title>Calculator Comision</title>
<style>
 body{font:14px/1.4 Arial,Helvetica,sans-serif;margin:6px}
 table{border-collapse:collapse;width:100%}
 th,td{border:1px solid #999;padding:3px 6px;text-align:left}
 th{background:#2d7e2d;color:#fff}
 .btn{padding:3px 8px;margin:2px;font-size:13px;cursor:pointer}
 .green{background:#2d7e2d;color:#fff;border:0}
 .yellow{background:#f0b400;color:#000;border:0}
 .red{background:#c62828;color:#fff;border:0}
</style>
</head><body>

<!----  BARA DE INTRODUCERE  ---->
<input id="agent"  placeholder="Nume agent">
<input id="luna"   placeholder="Luna (AAAA-LL)">
<input id="client" placeholder="Nume client">
<input id="suma"   placeholder="Suma">

<select id="banca">
  <option>BCR</option><option>BRD</option><option>ING</option>
  <option>UNICREDIT</option><option>RAIFFEISEN</option>
  <option>FIRST BANK</option><option>GARANTI</option>
  <option>ALPHA</option><option>PATRIA</option>
</select>
<select id="tip">
  <option>IP</option><option>REF IP</option>
  <option>NP</option><option>REF NP</option>
</select>
<select id="prov">
  <option>RECOMANDARI</option>
  <option>TEOCREDIT</option>
  <option>AGENT - DAF IMOBILIARE</option>
  <option>TCC - ADAMA</option>
</select>

<button class="btn green" onclick="add()">Adaugă credit</button>
<button class="btn yellow" onclick="calc()">Calculează</button>
<input type="file" id="csv" style="margin-left:8px">
<button class="btn" onclick="loadCSV()">Încarcă CSV</button>
<button class="btn" onclick="exportCSV()">Exportă CSV</button>
<button class="btn" onclick="exportXLS()">Exportă XLSX</button>

<p style="font-size:12px">(Agent &amp; lună apar doar în PDF / XLSX)</p>

<table id="t"><thead><tr>
 <th>#</th><th>Nume</th><th>Banca</th><th>Tip</th>
 <th>Suma</th><th>Provider</th><th>Proc.</th><th>Comision</th><th></th>
</tr></thead><tbody></tbody>
<tfoot><tr><td colspan="7" style="text-align:right">Total castig</td>
<td id="tot"></td><td></td></tr></tfoot></table>

<pre id="rez"></pre>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
<script>
const rows=[], tbody=document.querySelector('#t tbody');
const praguri={
  'RAIFFEISEN BANK' :[{min:0,max:800000,p:0.008},{min:800001,max:1e99,p:0.009}],
  'UNICREDIT BANK'  :[{min:0,max:800000,p:0.008},{min:800001,max:1e99,p:0.009}],
  'BCR'             :[{min:0,max:800000,p:0.008},
                      {min:800001,max:1600000,p:0.009},
                      {min:1600001,max:2400000,p:0.01},
                      {min:2400001,max:5e6,p:0.012}],
  'ING'             :[{min:0,max:1600000,p:0.008},{min:1600001,max:1e99,p:0.009}],
  'PATRIA BANK'     :[{min:0,max:800000,p:0.008},{min:800001,max:1600000,p:0.01},
                      {min:1600001,max:2400000,p:0.012},{min:2400001,max:1e99,p:0.014}],
  'ALPHA BANK'      :[{min:0,max:800000,p:0.008},{min:800001,max:1600000,p:0.009},
                      {min:1600001,max:1e99,p:0.01}],
  'BRD'             :[{min:0,max:1e99,p:0.008}],
  'FIRST BANK'      :[{min:0,max:1e99,p:0.008}],
  'GARANTI BANK'    :[{min:0,max:1e99,p:0.008}]
};

function canon(s){
  return String(s).replace(/[\[\]"']/g,'').replace(/\s+/g,' ').trim().toUpperCase();
}
function num(v){
  v=String(v).replace(/[\[\]"']/g,'').replace(/\./g,'').replace(',','.');
  return +v||0;
}
function add(nume,banca,tip,suma,prov){
  rows.push({
    nume : canon(nume||document.getElementById('client').value||'N/A'),
    banca: canon(banca||document.getElementById('banca').value),
    tip  : canon(tip||document.getElementById('tip').value),
    suma : num(suma||document.getElementById('suma').value),
    prov : canon(prov||document.getElementById('prov').value)
  });
  render();
}

function del(i){rows.splice(i,1);render();}

function render(){
  tbody.innerHTML='';
  rows.forEach((r,i)=>{
    tbody.insertAdjacentHTML('beforeend',`
      <tr><td>${i+1}</td><td>${r.nume}</td><td>${r.banca}</td><td>${r.tip}</td>
      <td>${r.suma.toLocaleString()}</td><td>${r.prov}</td>
      <td>${r.proc? (r.proc*100).toFixed(2)+'%':''}</td>
      <td>${r.com? r.com.toLocaleString(undefined,{minimumFractionDigits:2})+' RON':''}</td>
      <td><button class="btn red" onclick="del(${i})">x</button></td></tr>`);
  });
}

function calc(){
  let total=0, rez='';
  const banci=[...new Set(rows.map(r=>canon(r.banca)))];
  banci.forEach(b=>{
    const tot13=rows.filter(r=>canon(r.banca)===b && canon(r.prov)!=='TEOCREDIT')
                    .reduce((s,r)=>s+r.suma,0);
    const prag=(praguri[b]||[{p:0.008}]).find(p=>tot13>=p.min&&tot13<=p.max).p;
    rows.forEach(r=>{
      if(canon(r.banca)!==b) return;
      if(canon(r.prov)==='TEOCREDIT')      r.proc=0.004;
      else if(canon(r.prov).startsWith('AGENT')) r.proc=prag/2;
      else if(canon(r.prov).startsWith('TCC'))   r.proc=0.004;          // Cat 2
      else                                       r.proc=prag;           // Cat 1
      r.com = r.suma*r.proc;
      total+=r.com;
    });
    rez+=`${b}: total Cat1+3 = ${tot13.toLocaleString()} RON → prag ${ (prag*100).toFixed(2)}%\n`;
  });
  document.getElementById('tot').textContent=total.toLocaleString(undefined,{minimumFractionDigits:2});
  document.getElementById('rez').textContent=rez;
  render();
}

function loadCSV(){
  const f=document.getElementById('csv').files[0];
  if(!f) return;
  f.text().then(t=>{
    t.split(/\r?\n/).forEach(l=>{
      const [a,b,c,d,e]=l.split(',');
      if(b&&d) add(a,b,c,d,e);
    });
  });
}
function exportCSV(){
  const hdr='Nume,Banca,Tip,Suma,Provider,Proc,Comision\n';
  const body=rows.map(r=>
    [r.nume,r.banca,r.tip,r.suma,r.prov,(r.proc*100).toFixed(2)+'%',r.com.toFixed(2)]
    .join(',')).join('\n');
  download('borderou.csv',hdr+body);
}
function exportXLS(){
 if(typeof XLSX==='undefined'){alert('SheetJS nu s-a încărcat!');return;}
 const ws=XLSX.utils.json_to_sheet(rows.map((r,i)=>({
   Nr:i+1,Nume:r.nume,Banca:r.banca,Tip:r.tip,Suma:r.suma,Provider:r.prov,
   Proc:(r.proc*100).toFixed(2)+'%',Comision:r.com.toFixed(2)
 })));
 const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Borderou');
 XLSX.utils.sheet_add_aoa(ws,[[`Agent: ${document.getElementById('agent').value||'-'}`,
                               `Luna: ${document.getElementById('luna').value||'-'}`]],{origin:-1});
 XLSX.writeFile(wb,'borderou.xlsx');
}
function download(nm,txt){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([txt],{type:'text/csv'}));
  a.download=nm;a.click();URL.revokeObjectURL(a.href);
}
</script>
</body></html>
