<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="utf-8">
<title>Calculator Comision v50</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;font-size:14px;margin:0;padding:8px}
input,select,button{margin:2px;padding:4px;font-size:14px}
table{width:100%;border-collapse:collapse;margin-top:6px}
th,td{border:1px solid #3a873a;padding:4px;text-align:center}
th{background:#3a873a;color:#fff}
tbody tr:nth-child(even){background:#f8fff8}
#totalRow td{font-weight:700}
button.del{background:#d33;color:#fff;border:0;border-radius:3px;cursor:pointer;padding:0 8px}
button.green {background:#2f8f2f;color:#fff;border:0;border-radius:3px;cursor:pointer}
button.yellow{background:#ffb400;color:#000;border:0;border-radius:3px;cursor:pointer}
.summary{font-family:monospace;font-size:12px;white-space:pre;margin-top:4px}
</style>
<!-- SheetJS pentru XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
</head>
<body>

<!-- Formular de introducere -->
<input id="agent" placeholder="Nume agent">
<input id="luna"  placeholder="Luna (AAAA-LL)" value="">
<input id="client"placeholder="Nume client" >
<input id="suma"  placeholder="Suma" style="width:80px">
<select id="banca">
  <option>BCR</option><option>BRD</option><option>ING</option><option>UNICREDIT</option>
  <option>GARANTI</option><option>FIRST BANK</option><option>ALPHA</option>
  <option>RAIFFEISEN</option><option>FIRST BANK</option>
</select>
<select id="tip">
  <option>IP</option><option>REF IP</option>
  <option>NP</option><option>REF NP</option>
</select>
<select id="prov">
  <option>RECOMANDARI</option>
  <option>TEOCREDIT</option>
  <option>AGENT - DAF IMOBILIARE</option>
  <option>TCC - ADAMA</option>
</select>
<button class="green" onclick="addRow()">Adaugă credit</button>
<button class="yellow" onclick="calc()">Calculează</button><br>

<!-- import / export -->
<input type="file" id="csvIn">
<button onclick="loadCSV()">Încarcă CSV</button>
<button onclick="saveCSV()">Exportă CSV</button>
<button onclick="saveXLSX()">Exportă XLSX</button>

<!-- tabel -->
<table id="tbl">
<thead>
<tr><th>#</th><th>Nume</th><th>Banca</th><th>Tip</th><th>Suma</th>
    <th>Provider</th><th>Proc.</th><th>Comision</th><th></th></tr>
</thead>
<tbody></tbody>
<tfoot><tr id="totalRow"><td colspan="7">Total câştig</td><td></td><td></td></tr></tfoot>
</table>

<pre class="summary" id="rez"></pre>

<script>
//--- praguri ipotecar Cat 1 & 3 ------------------------------------------
const pragIpotecar = {
 BCR:[ [0,.008],[800001,.009],[1600001,.01],[2400001,.012],[5000001,.014],[5e7+.1,.018] ],
 PATRIA:[ [0,.008],[800001,.01],[1600001,.012],[2400001,.014] ],
 ALPHA:[ [0,.008],[800001,.009],[1600001,.01] ],
 "CREDIT EUROPE BANK":[ [0,.008],[800001,.011] ],
 UNICREDIT:[ [0,.008],[800001,.009] ],
 ING:[ [0,.008],[1600001,.009] ],
 RAIFFEISEN:[ [0,.008],[800001,.009] ],
 BT:[ [0,.008] ], BRD:[[0,.008]], LIBRA:[[0,.008]],
 "FIRST BANK":[[0,.008]], GARANTI:[[0,.008]]
};
// bănci fără prag (0,4 %) la Cat2 ipotecar:
const toateBancile = Object.keys(pragIpotecar);

const rows=[];  // memorie rânduri

function addRow(){
 const nume  = document.getElementById('client').value||'N/A';
 const banca = document.getElementById('banca').value;
 const tip   = document.getElementById('tip').value;
 const suma  = parseFloat(document.getElementById('suma').value.replace(/\./g,''))||0;
 const prov  = document.getElementById('prov').value.toUpperCase();
 rows.push({nume,banca,tip,suma,prov,proc:0,com:0});
 render();
}

function render(){
 const tb=document.querySelector('#tbl tbody'); tb.innerHTML='';
 rows.forEach((r,i)=>{
   tb.insertRow().innerHTML=`<td>${i+1}</td><td>${r.nume}</td><td>${r.banca}</td><td>${r.tip}</td>
   <td>${fmt(r.suma)}</td><td>${r.prov}</td><td>${(r.proc*100).toFixed(2)}%</td>
   <td>${fmt(r.com)}</td>
   <td><button class="del" onclick="delRow(${i})">x</button></td>`;
 });
 document.querySelector('#totalRow td:nth-child(8)').textContent=
   fmt(rows.reduce((a,b)=>a+b.com,0));
}

function delRow(i){ rows.splice(i,1); render(); }

function pragBanca(banca,total){
 const p=pragIpotecar[banca];
 if(!p) return .008;
 return p.reverse().find(v=>total>=v[0])[1];
}

function calc(){
 // reset
 rows.forEach(r=>{r.proc=r.com=0;});
 // grupare pe bancă
 const grup={};
 rows.forEach(r=>{
   const cat = r.prov.startsWith('TEOCREDIT')||r.prov.startsWith('TCC')?2:
               r.prov.startsWith('AGENT')?3:1;
   const key=r.banca+(cat===2?'_C2':'');   // Cat2 separat (0.4%)
   grup[key]=(grup[key]||0)+ (cat===2?0: r.suma); // doar Cat1+3 pentru prag
 });
 // aplică
 rows.forEach(r=>{
   const cat = r.prov.startsWith('TEOCREDIT')||r.prov.startsWith('TCC')?2:
               r.prov.startsWith('AGENT')?3:1;
   // NP / REF NP – se plătesc doar la unele bănci:
   if(r.tip.includes('NP')){
      const mp = {PATRIA:.012, UNICREDIT:.02, "FIRST BANK":.02, GARANTI:.012, ING:.004};
      r.proc = mp[r.banca]||0;
   }else{ // ipotecar
      if(cat===2){ r.proc=.004; }
      else if(cat===3){ r.proc = pragBanca(r.banca, grup[r.banca]); r.proc/=2;}
      else { r.proc = pragBanca(r.banca, grup[r.banca]); }
   }
   // plafonări simple
   if(r.banca==='BRD' && r.com>7000) r.com=7000;
   r.com = +(r.suma*r.proc).toFixed(2);
 });
 // rezumat
 let rez='';
 Object.entries(grup).forEach(([b,t])=>{
   if(b.endsWith('_C2')) return;
   rez+=`${b.replace('_C2','')}: total Cat1+3 = ${fmt(t)} RON → prag ${(pragBanca(b.replace('_C2',''),t)*100).toFixed(2)}%\n`;
 });
 document.getElementById('rez').textContent=rez;
 render();
}

function fmt(v){return v.toLocaleString('ro-RO',{minimumFractionDigits:2,maximumFractionDigits:2});}

// ---------------- CSV I/O -----------------
function loadCSV(){
 const f=document.getElementById('csvIn').files[0]; if(!f)return;
 f.text().then(t=>{
   t.trim().split(/\r?\n/).forEach(l=>{
     const [n,b,tip,s,prov]=l.split(',');
     if(!b||!s) return;
     rows.push({nume:n||'N/A',banca:b.trim(),tip:tip.trim(),suma:+s,prov:prov.trim().toUpperCase(),proc:0,com:0});
   });
   render(); calc();
 });
}
function saveCSV(){
 const head='Nume,Banca,Tip,Suma,Provider\n';
 const body=rows.map(r=>[r.nume,r.banca,r.tip,r.suma,r.prov].join(',')).join('\n');
 dl(head+body,'borderou.csv','text/csv');
}
// ---------------- XLSX --------------------
function saveXLSX(){
 /* construit sheet */
 const data=[['#','Nume','Banca','Tip','Suma','Provider','Proc.','Comision']];
 rows.forEach((r,i)=>data.push([i+1,r.nume,r.banca,r.tip,r.suma,r.prov,r.proc*100+'%',r.com]));
 const ws=XLSX.utils.aoa_to_sheet(data);
 const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Borderou');
 XLSX.writeFile(wb,'borderou.xlsx');
}

/* util */
function dl(txt,name,type){
 const a=document.createElement('a');
 a.href='data:'+type+';charset=utf-8,'+encodeURIComponent(txt);
 a.download=name; a.click();
}

</script>
</body>
</html>
