<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="utf-8">
<title>Calculator Comision</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body{padding:15px;font-size:.9rem}
table{font-size:.8rem}
thead th, tfoot td{background:#228b22;color:#fff}
tfoot td{font-weight:700}
</style>

<!-- biblioteci pentru export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28"></script>
</head>
<body>
<h3 class="text-success font-weight-bold">Calculator Comision</h3>

<div class="form-row mb-2">
  <div class="col-2"><input id="agent"   class="form-control form-control-sm" placeholder="Nume agent"></div>
  <div class="col-2"><input id="luna"    class="form-control form-control-sm" placeholder="Luna (AAAA-LL)"></div>
  <div class="col-3"><input id="nume"    class="form-control form-control-sm" placeholder="Nume client"></div>

  <div class="col-2">
     <select id="banca" class="form-control form-control-sm">
      <option>BCR</option><option>BRD</option><option>ING</option><option>UNICREDIT</option>
      <option>GARANTI</option><option>FIRST BANK</option><option>ALPHA</option>
      <option>RAIFFEISEN</option><option>PATRIA</option><option>LIBRA</option>
      <option>CREDIT EUROPE</option>
    </select>
  </div>
  <div class="col-1">
     <select id="tip" class="form-control form-control-sm">
       <option>IP</option><option>REF IP</option>
       <option>NP</option><option>REF NP</option>
     </select>
  </div>
  <div class="col-2"><input id="suma" class="form-control form-control-sm" placeholder="Suma"></div>
</div>

<div class="form-row mb-2">
  <div class="col-3">
    <select id="prov" class="form-control form-control-sm">
      <option>RECOMANDARI</option>
      <option>TEOCREDIT</option>
      <option>TCC - ADAMA</option><option>TCC - WHITE POINT</option>
      <option>AGENT - DAF IMOBILIARE</option><option>AGENT - BEE IMOBILIARE</option>
      <option>ADAMA ESTATE</option>
    </select>
  </div>

  <div class="col-auto">
    <button onclick="addRow()" class="btn btn-success btn-sm">Adaugă credit</button>
    <button onclick="calc()"    class="btn btn-warning btn-sm">Calculează</button>
  </div>

  <div class="col-auto">
    <input type="file" id="csv" class="btn btn-light btn-sm">
    <button onclick="loadCSV()" class="btn btn-primary btn-sm">Încarcă CSV</button>
  </div>

  <div class="col-auto">
    <button onclick="exportPDF()"   class="btn btn-secondary btn-sm">Exportă PDF</button>
    <button onclick="exportCSV()"   class="btn btn-secondary btn-sm">Exportă CSV</button>
    <button onclick="exportXLSX()"  class="btn btn-secondary btn-sm">Exportă XLSX</button>
    <button onclick="exportHTML()"  class="btn btn-secondary btn-sm">Exportă XLS (HTML)</button>
  </div>
</div>

<table id="tbl" class="table table-bordered table-sm">
 <thead><tr>
   <th>#</th><th>Nume</th><th>Banca</th><th>Tip</th><th>Suma</th>
   <th>Provider</th><th>Proc.</th><th>Comision</th><th></th>
 </tr></thead>
 <tbody></tbody>
 <tfoot><tr>
   <td colspan="7" class="text-right">Total castig</td>
   <td id="tot" class="font-weight-bold"></td><td></td>
 </tr></tfoot>
</table>

<p id="rez" style="white-space:pre-wrap;font-size:.8rem"></p>

<script>
/* ===== 1. Tabele de praguri IP ===== */
const GRILA_IP = {
 BCR: [[0,.008],[800001,.009],[1600001,.010],[2400001,.012],[5000001,.014],[50000001,.018]],
 PATRIA:[[0,.008],[800001,.010],[1600001,.012],[2400001,.014]],
 ALPHA:[[0,.008],[800001,.009],[1600001,.010]],
 "CREDIT EUROPE":[[0,.008],[800001,.011]],
 UNICREDIT:[[0,.008],[800001,.009]],
 GARANTI:[[0,.008]],
 "FIRST BANK":[[0,.008]],
 ING:[[0,.008],[1600001,.009]],
 RAIFFEISEN:[[0,.008],[800001,.009]],
 BRD:[[0,.008]],
 LIBRA:[[0,.008]]
};
/* ===== 1b. Nevoi personale ===== */
const NP_CAT1 = {PATRIA:1.2,GARANTI:1.2,UNICREDIT:2,"FIRST BANK":2,ING:.4};
const NP_CAT2 = {PATRIA:1,   GARANTI:1,  UNICREDIT:1,"FIRST BANK":1,ING:.4};
const CAT2_IP = .004;

/* ==== 2. Helpers ==== */
const $=id=>document.getElementById(id);
const rows=[];
const num=v=>+String(v).replace(/[ .]/g,'').replace(',','.')||0;
const fmt=n=>n.toLocaleString('ro-RO',{minimumFractionDigits:2,maximumFractionDigits:2});
const categoria=p=>/^AGENT/.test(p)?3:/^(TCC|TEOCREDIT)/.test(p)?2:1;

/* ==== 3. Procente ==== */
function pragIP(banca,totalCat13,cat){
  let p=.008;
  (GRILA_IP[banca]||[]).forEach(([t,val])=>{if(totalCat13>=t)p=val});
  return cat===3? p/2 : p;
}
function pragNP(banca,cat){
  if(cat===3) return 0;            // NP – Cat 3 NU se plăteşte
  return cat===2 ? (NP_CAT2[banca]||0) : (NP_CAT1[banca]||0);
}

/* ==== 4. CRUD ==== */
function render(total=0){
  const tb=$("tbl").tBodies[0]; tb.innerHTML='';
  rows.forEach((r,i)=>{
    tb.insertRow().innerHTML=
     `<td>${i+1}</td><td>${r.nume}</td><td>${r.banca}</td><td>${r.tip}</td>
      <td>${fmt(r.suma)}</td><td>${r.prov}</td>
      <td>${r.pr? (r.pr*100).toFixed(2)+'%':''}</td>
      <td>${r.com? fmt(r.com)+' RON':''}</td>
      <td><button class="btn btn-danger btn-sm" onclick="del(${i})">x</button></td>`;
  });
  $("tot").textContent= total? fmt(total):'';
}
function addRow(){
  const s=num($("suma").value); if(!s) return;
  rows.push({nume:$("nume").value||'N/A',banca:$("banca").value,
             tip:$("tip").value,suma:s,prov:$("prov").value});
  $("suma").value=''; render();
}
function del(i){rows.splice(i,1);render();}

/* ==== 5. Calcul principal ==== */
function calc(){
  const sCat13={};
  rows.forEach(r=>{
    const c=categoria(r.prov);
    if(r.tip.includes('IP')&&c!==2)
       sCat13[r.banca]=(sCat13[r.banca]||0)+r.suma;
  });
  let tot=0, rez='';
  rows.forEach(r=>{
    const cat=categoria(r.prov);
    if(r.tip.includes('NP'))
         r.pr=pragNP(r.banca,cat);
    else if(cat===2)
         r.pr=CAT2_IP;
    else
         r.pr=pragIP(r.banca,sCat13[r.banca]||0,cat);
    r.com=r.suma*r.pr; tot+=r.com;
  });
  /* rezumat */
  Object.entries(sCat13).forEach(([b,s])=>{
     const pr=pragIP(b,s,1); rez+=`${b}: total Cat1+3 = ${fmt(s)} RON → prag = ${(pr*100).toFixed(2)}%\n`;
  });
  $("rez").textContent=rez; render(tot);
}

/* ==== 6. CSV ==== */
function loadCSV(){
 const f=$("csv").files[0]; if(!f) return;
 f.text().then(t=>{
   t.trim().split(/\r?\n/).forEach(l=>{
     const [n,b,t,s,p]=l.split(',');
     if(b&&s){rows.push({nume:n||'N/A',banca:b.trim(),tip:t.trim(),suma:+s,prov:p.trim()});}
   });
   render();
 });
}
function exportCSV(){
  let str='Nume,Banca,Tip,Suma,Provider,Proc,Comision\n';
  rows.forEach(r=>str+=`${r.nume},${r.banca},${r.tip},${r.suma},${r.prov},${r.pr},${r.com}\n`);
  saveAs(new Blob([str],{type:'text/csv;charset=utf-8'}),'borderou.csv');
}

/* ==== 7. XLSX ==== */
function exportXLSX(){
 try{
  const data=[['#','Nume','Banca','Tip','Suma','Provider','Proc','Comision']];
  rows.forEach((r,i)=>data.push([i+1,r.nume,r.banca,r.tip,r.suma,r.prov,r.pr,r.com]));
  const ws=XLSX.utils.aoa_to_sheet(data);
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Borderou');
  XLSX.writeFile(wb,'borderou.xlsx');
 }catch(e){alert('SheetJS nu s-a încărcat – rulează offline sau CDN blocat');}
}
/* ==== 7b. fallback HTML-table ==== */
function exportHTML(){
 const html=`<table>${$("tbl").innerHTML}</table>`;
 const blob=new Blob([html],{type:'application/vnd.ms-excel'});
 saveAs(blob,'borderou.xls');
}

/* ==== 8. PDF ==== */
function exportPDF(){
 const {jsPDF}=window.jspdf; const doc=new jsPDF('l','pt','a4');
 const hdr=[['#','Nume','Banca','Tip','Suma','Provider','Proc','Comision']];
 const body=rows.map((r,i)=>[i+1,r.nume,r.banca,r.tip,fmt(r.suma),r.prov,(r.pr*100).toFixed(2)+'%',fmt(r.com)]);
 doc.text(`Agent: ${$("agent").value||'-'}   Luna: ${$("luna").value||'-'}`,40,40);
 doc.autoTable({head:hdr,body,startY:60,theme:'grid',styles:{fontSize:8}});
 doc.save('borderou.pdf');
}
</script>
</body>
</html>
