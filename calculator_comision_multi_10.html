<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="utf-8">
<title>Calculator comision</title>
<style>
  body{font-family:sans-serif;margin:0 6px}
  table{border-collapse:collapse;width:100%;margin-top:6px}
  th,td{border:1px solid #3a6c3a;padding:3px 6px;font-size:14px}
  th{background:#3a6c3a;color:#fff;text-align:left}
  tr:nth-child(even){background:#f5fff5}
  input,select,button{font-size:14px;margin:2px}
  .btn{padding:3px 7px;cursor:pointer}
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>

<!-- ─────────────────────────── FORM HEADER ────────────────────────── -->
<label>Nume agent <input id="numeAgent"></label>
<label>Luna (AAAA-LL) <input id="luna"></label>
<label>Nume client <input id="numeClient"></label>
<label>Suma <input id="inputSuma" type="number" value="0"></label>
<select id="bancaSelect"></select>
<select id="tipSelect">
  <option>IP</option><option>REF IP</option>
  <option>NP</option><option>REF NP</option>
  <option>NC</option>
</select>
<select id="providerSelect">
  <option>RECOMANDARI</option>
  <option>TEOCREDIT</option>
  <option>AGENT - DAF IMOBILIARE</option>
  <!-- poți adăuga oricâte AGENT - ... -->
</select>
<button id="add"  class="btn" style="background:#2d9f2d;color:#fff">Adaugă credit</button>
<button id="calc" class="btn" style="background:#f2a41f">Calculează</button><br>

<input type="file" id="fileCsv">
<button id="loadCsv"   class="btn">Încarcă CSV</button>
<button id="exportCsv" class="btn">Exportă CSV</button>
<button id="exportXls" class="btn">Exportă XLSX</button>

<!-- ─────────────────────────── TABEL UI ───────────────────────────── -->
<table id="tbl">
<thead><tr>
<th>#</th><th>Nume</th><th>Banca</th><th>Tip</th>
<th>Suma</th><th>Provider</th><th>Proc.</th><th>Comision</th><th></th></tr></thead>
<tbody></tbody>
<tfoot><tr><td colspan="7" style="text-align:right;font-weight:700">Total câștig</td>
<td id="tot" style="font-weight:700"></td><td></td></tr></tfoot>
</table>

<pre id="debug" style="font-size:13px"></pre>

<script>
/* ───────────────────────– configurare bănci –─────────────────────── */
const PRAG = {               // Cat 1 & 3 (IP / REF IP / CONSTR / TEREN)
  BCR:[.008,.009,.01,.012,.014,.018],
  ING:[.008,.009],
  UNICREDIT:[.008,.009],
  RAIFFEISEN:[.008,.009],
  ALPHA:[.008,.009,.01],
  PATRIA:[.008,.01,.012,.014],
  BT:[.008], BRD:[.008], LIBRA:[.008],
  GARANTI:[.008], "FIRST BANK":[.008]
};
const CAT2 = .004;           // toate creditele trimise de TeoCredit
const FIXE = {               // procente fixe (NP / NC)
  NP :{PATRIA:.012, UNICREDIT:.02, FIRST:.02, GARANTI:.012, ING:.004},
  NC :{BCR:.002, BRD:.004, ING:.003, BT:.008}
};
const CAP = {BRD:7000, PATRIA:10000, GARANTI:5000}; // plafoane/credit

/* ───────────────────────– variabile globale –─────────────────────── */
let rows=[]; const tbody=$('#tbl tbody');
const banci=Object.keys(PRAG); // pt dropdown
$('#bancaSelect').innerHTML=banci.map(b=>`<option>${b}</option>`).join('');

/* ───────────────────────– helper DOM mini –───────────────────────── */
function $(q){return document.querySelector(q)}
function ce(el,tag){return el.insertCell(tag)}
const fmt=(x)=>x.toLocaleString('ro-RO',{minimumFractionDigits:0,maximumFractionDigits:2});

/* ───────────────────────– adăugare manuală –──────────────────────── */
$('#add').onclick=()=>{
  const nume=$('#numeClient').value||'N/A';
  rows.push({
    nume,banca:$('#bancaSelect').value.trim(),
    tip:$('#tipSelect').value.trim(),
    suma:+$('#inputSuma').value||0,
    prov:$('#providerSelect').value.trim()
  });
  render();
};

/* ───────────────────────– CSV ↔ rows –────────────────────────────── */
$('#loadCsv').onclick=async()=>{
  const f=$('#fileCsv').files[0]; if(!f)return;
  const text=await f.text();
  text.split(/\r?\n/).forEach(l=>{
    const [nume,banca,tip,suma,prov]=l.split(',');
    if(banca&&suma&&!isNaN(+suma))
      rows.push({nume:nume?.replaceAll('"','').trim()||'N/A',
                 banca:banca.replaceAll('"','').replaceAll('[','').replaceAll(']','').trim(),
                 tip:tip.replaceAll('"','').trim(),suma:+suma,prov:prov.replaceAll('"','').trim()});
  }); render();
};
$('#exportCsv').onclick=()=>downloadCSV(rows);
function downloadCSV(arr){
  const head='Nume,Banca,Tip,Suma,Provider\n';
  const body=arr.map(r=>[r.nume,r.banca,r.tip,r.suma,r.prov].join(',')).join('\n');
  const blob=new Blob([head+body],{type:'text/csv'});
  dl(blob,'borderou.csv');
}

/* ───────────────────────– export XLSX (fallback CSV) –────────────── */
$('#exportXls').onclick=()=>{
  if(typeof XLSX==='undefined'){alert('SheetJS nu s-a încărcat – salvez CSV');
    return downloadCSV(rows);}
  const ws=XLSX.utils.json_to_sheet(rows);
  const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Borderou');
  XLSX.writeFile(wb,'borderou.xlsx');
};

/* ───────────────────────– logica de calcul –──────────────────────── */
$('#calc').onclick=()=>{ calc(); render(); };

function calc(){
  // reset
  rows.forEach(r=>{r.proc=0;r.com=0});
  // grupează sumele Cat 1+3 per bancă (IP / REF IP)
  const tot={};
  rows.forEach(r=>{
    if(!r.banca) return;
    const cat = r.prov.startsWith('TEOCREDIT')?2:
                r.prov.startsWith('AGENT')?3:1;
    if(cat===1||cat===3){
      if(!/NP/i.test(r.tip))    // NP nu intră la praguri
        (tot[r.banca]??=0, tot[r.banca]+=r.suma);
    }
  });
  // calculează procente & comision
  rows.forEach(r=>{
    const B=r.banca.toUpperCase();
    const cat = r.prov.startsWith('TEOCREDIT')?2:
                r.prov.startsWith('AGENT')?3:1;
    let p=0;
    if(/NP/i.test(r.tip)){              // Nevoi personale
      p=FIXE.NP[B]||0;
    }else if(/NC/i.test(r.tip)){        // Noua Casă
      p=FIXE.NC[B]||0;
    }else if(cat===2){                  // Cat2
      p=CAT2;
    }else{                              // Cat1 sau 3 (ipotecar)
      const pragList=PRAG[B]||[.008];
      let idx=Math.floor(tot[B]/800000);
      if(idx>=pragList.length)idx=pragList.length-1;
      p=pragList[idx]*(cat===3?0.5:1);
    }
    // plafon
    let com=r.suma*p;
    const cap=CAP[B];
    if(cap) com=Math.min(com,cap);
    r.proc=p; r.com=com;
  });
}

/* ───────────────────────– afișare –───────────────────────────────── */
function render(){
  tbody.innerHTML='';
  rows.forEach((r,i)=>{
    const tr=tbody.insertRow();
    [i+1,r.nume,r.banca,r.tip,fmt(r.suma),r.prov,
     r.proc? (r.proc*100).toFixed(2)+'%':'', r.com?fmt(r.com)+' RON':''
    ].forEach((t,j)=>tr.insertCell(j).textContent=t);
    // buton ștergere
    const x=tr.insertCell(8);
    const b=document.createElement('button');b.textContent='x';b.className='btn';
    b.onclick=()=>{rows.splice(i,1);render()};x.appendChild(b);
  });
  // total
  const total=rows.reduce((s,r)=>s+r.com,0);
  $('#tot').textContent=fmt(total);
  // debug praguri
  let dbg='';
  for(const [b,sum] of Object.entries(tot)){
    const prag=rows.find(r=>r.banca.toUpperCase()===b&&r.proc)?.proc||0;
    dbg+=`${b}: total Cat1+3 = ${fmt(sum)} RON → prag ${(prag*100).toFixed(2)}%\n`;
  }
  $('#debug').textContent=dbg;
}

/* ───────────────────────– util –──────────────────────────────────── */
function dl(blob,name){const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download=name;a.click();URL.revokeObjectURL(a.href);}
</script>
</body>
</html>
