<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="utf-8">
<title>Calculator Comision 111</title>
<style>
/* aspect minimal: te poți întoarce la Bootstrap punând
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"> */
body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;font-size:.9rem;margin:0 8px}
table{border-collapse:collapse;margin-top:6px;width:100%}
th,td{border:1px solid #4e7c4e;padding:2px 6px;text-align:left}
th{background:#328030;color:#fff;font-weight:600}
tr:nth-child(even){background:#f4fff4}
input,select,button{margin:2px;padding:4px;font-size:.85rem}
button{cursor:pointer;border:1px solid #555;border-radius:3px;background:#eee}
button.green{background:#2d8c2d;color:#fff;border:none}
button.yellow{background:#f6b400;color:#000;border:none}
button.red{background:#c52e2e;color:#fff;border:none;padding:2px 7px}
tfoot td{font-weight:700;text-align:right}
.debug{font-family:monospace;white-space:pre;margin-top:6px}
</style>
</head>
<body>

<!-- bara de introducere -->
<label>Nume agent <input   id="agent"  placeholder="Agent"></label>
<label>Luna (AAAA-LL) <input id="luna"   placeholder="2025-06"></label>
<label>Nume client <input  id="numeCl" placeholder="Nume"></label>
<label>Suma <input type="number" id="suma" value="0"></label>

<select id="banca">
  <option>BCR</option><option>BRD</option><option>ING</option><option>UNICREDIT</option>
  <option>GARANTI</option><option>FIRST BANK</option><option>ALPHA</option><option>RAIFFEISEN</option>
  <option>PATRIA</option><option>FIRST BANK</option><option>LIBRA</option><option>CREDIT EUROPE</option>
</select>
<select id="tip"><option>IP</option><option>REF IP</option><option>NP</option><option>REF NP</option></select>
<select id="prov">
  <option>RECOMANDARI</option>
  <option>TEOCREDIT</option>
  <option>AGENT - DAF IMOBILIARE</option>
  <option>AGENT - BEE IMOBILIARE</option>
  <option>Adama Estate</option>
</select>

<button class="green" onclick="addRow()">Adaugă credit</button>
<button class="yellow" onclick="calcAll()">Calculează</button>
<br>

<input type="file" id="csv" accept=".csv">
<button onclick="loadCSV()">Încarcă CSV</button>
<button onclick="exportCSV()">Exportă CSV</button>
<button onclick="exportXLSX()">Exportă XLSX</button>

<table id="tbl">
<thead><tr>
<th>#</th><th>Nume</th><th>Banca</th><th>Tip</th><th>Suma</th>
<th>Provider</th><th>Proc.</th><th>Comision</th><th></th></tr></thead>
<tbody></tbody>
<tfoot><tr><td colspan="7">Total câștig</td><td id="tot"></td><td></td></tr></tfoot>
</table>

<div id="rez" class="debug"></div>

<!-- SheetJS + FileSaver pentru export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<script>
/* ---------- CONFIG PRAGURI ---------- */
const PRAG_IP = {
  "BCR":[[0,.008],[800001,.009],[1600001,.01],[2400001,.012],[5000001,.014],[50000001,.018]],
  "UNICREDIT":[[0,.008],[800001,.009]],
  "ING":[[0,.008],[1600001,.009]],
  "RAIFFEISEN":[[0,.008],[800001,.009]],
  "ALPHA":[[0,.008],[800001,.009],[1600001,.01]],
  "PATRIA":[[0,.008],[800001,.01],[1600001,.012],[2400001,.014]],
  "CREDIT EUROPE":[[0,.008],[800001,.011]],
  "GARANTI":[[0,.008]],
  "FIRST BANK":[[0,.008]],
  "BRD":[[0,.008]],
  "LIBRA":[[0,.008]]
};
const PROC_CAT2_IP = .004;                       // 0,40 %
const PROC_NP      = {                          // NP & REF NP
  "PATRIA":.012,"UNICREDIT":.02,"FIRST BANK":.02,"GARANTI":.012,"ING":.004
};
/* ------------------------------------ */

let rows=[];
const $=id=>document.getElementById(id);

function clean(s=''){
  if(!s) return '';
  return s
    .toString()
    .replace(/^\s*\[\s*"?|"?\s*\]\s*$/g,'')    // [ "text" ] → text
    .replace(/^"+|"+$/g,'')                    // "text"    → text
    .trim()
    .toUpperCase();
}

function addRow(){
  rows.push({
    nume : clean($('numeCl').value)||'N/A',
    banca: clean($('banca').value),
    tip  : clean($('tip').value),
    suma : +$('suma').value||0,
    prov : clean($('prov').value)
  });
  render();
}

function del(i){ rows.splice(i,1); render(); }

/* --- calcul prog prag în funcție de sumă --- */
function pragBanca(banca, sumaTotal){
  const v=PRAG_IP[banca]||[[0,.008]];
  for(let i=v.length-1;i>=0;i--) if(sumaTotal>=v[i][0]) return v[i][1];
  return .008;
}

function calcAll(){
  let total=0,info='';
  /* grupăm pe bancă TOTAL Cat1+3 (prov≠TEOCREDIT) */
  const sume={};
  rows.forEach(r=>{
     if(r.tip.startsWith('NP')) return;                // NP – nu influențează prag IP
     if(r.prov==='TEOCREDIT') return;                 // Cat2 nu intră în sumă
     sume[r.banca]=(sume[r.banca]||0)+r.suma;
  });
  /* parcurgem și setăm procente */
  rows.forEach(r=>{
     let p=0;
     if(r.tip.startsWith('NP')){                      // NP / REF NP
        p = PROC_NP[r.banca]||0;
     }else{                                           // IP / REF IP
        if(r.prov==='TEOCREDIT' || r.prov.startsWith('TCC -'))       p=PROC_CAT2_IP;
        else if(r.prov.startsWith('AGENT'))                               p=pragBanca(r.banca,sume[r.banca])/2;
        else                                                               p=pragBanca(r.banca,sume[r.banca]);
     }
     r.proc=p;
     r.com=r.suma*p;
     total+=r.com;
  });
  $('tot').textContent = total.toLocaleString('ro-RO',{minimumFractionDigits:2});
  /* rezumat */
  info='';
  Object.entries(sume).forEach(([b,s])=>{
    info+=`${b}: total Cat1+3 = ${s.toLocaleString('ro-RO')} RON → prag ${(pragBanca(b,s)*100).toFixed(2)}%\n`;
  });
  $('rez').textContent=info;
  render();                 // pentru a afișa procente + comision
}

function render(){
  const tb=$('tbl').tBodies[0]; tb.innerHTML='';
  rows.forEach((r,i)=>{
    const tr=tb.insertRow();
    tr.innerHTML=`<td>${i+1}</td><td>${r.nume}</td><td>${r.banca}</td>
    <td>${r.tip}</td><td>${r.suma.toLocaleString('ro-RO')}</td>
    <td>${r.prov}</td><td>${r.proc? (r.proc*100).toFixed(2)+'%' :''}</td>
    <td>${r.com? r.com.toLocaleString('ro-RO',{minimumFractionDigits:2})+' RON':''}</td>
    <td><button class="red" onclick="del(${i})">x</button></td>`;
  });
}

function loadCSV(){
  const f=$('csv').files[0]; if(!f) return;
  f.text().then(txt=>{
     txt.split(/\r?\n/).forEach(l=>{
       if(!l.trim()) return;
       const [n,b,t,s,p]=l.split(',');
       if(b && s && !isNaN(+s))
         rows.push({nume:clean(n)||'N/A',banca:clean(b),tip:clean(t),
                    suma:+s,prov:clean(p)});
     });
     render(); calcAll();
  });
}
function exportCSV(){
  const lines=['NUME,BANCA,TIP,SUMA,PROVIDER'];
  rows.forEach(r=>lines.push([r.nume,r.banca,r.tip,r.suma,r.prov].join(',')));
  const blob=new Blob([lines.join('\n')],{type:'text/csv'});
  saveAs(blob,'comisioane.csv');
}
function exportXLSX(){
  const ws=XLSX.utils.json_to_sheet(rows.map(r=>({
    NUME:r.nume,BANCA:r.banca,TIP:r.tip,SUMA:r.suma,PROVIDER:r.prov,
    PROC:(r.proc*100).toFixed(2)+'%',COMISION:r.com
  })));
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Comisioane');
  XLSX.writeFile(wb,'comisioane.xlsx');
}
/* init – o randare goală */
render();
</script>
</body>
</html>
