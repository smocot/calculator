<!DOCTYPE html>
<html lang="ro">
<head><meta charset="utf-8">
<title>Calculator comision</title>
<style>
 *{box-sizing:border-box;font-family:system-ui,Arial}
 body{margin:0;padding:1rem;background:#f6f8f9}
 h1{margin:.2rem 0}
 table{width:100%;border-collapse:collapse;margin-top:.6rem}
 th,td{border:1px solid #8bb;border-left:0;border-right:0;padding:.35rem .5rem;font-size:.9rem}
 th{background:#0a7d29;color:#fff;text-align:left}
 tr:nth-child(even){background:#ecf5ee}
 #toolbar{display:flex;flex-wrap:wrap;gap:.4rem;margin-bottom:.4rem}
 #toolbar input[type=text],#toolbar input[type=number]{padding:.25rem .35rem;font-size:.9rem;max-width:140px}
 button{padding:.35rem .6rem;font-size:.85rem;border:0;border-radius:4px;cursor:pointer}
 button.green{background:#149f3c;color:#fff}
 button.orange{background:#f5a623;color:#fff}
 .del{background:#d9534f;color:#fff;padding:.2rem .45rem;font-size:.8rem}
 .right{text-align:right}
</style>
</head>
<body>

<h1>Calculator comision</h1>

<div id="toolbar">
  <button id="calcBtn" class="orange">Calculează</button>

  <label>Nume agent <input type="text" id="agent"></label>
  <label>Luna (AAAA-LL) <input type="text" id="luna" placeholder="2025-06"></label>
  <label>Nume client <input type="text" id="client"></label>
  <label>Suma <input type="number" id="suma" value="0"></label>

  <select id="bancaSel">
    <option>FIRST BANK</option><option>UNICREDIT BANK</option><option>RAIFFEISEN BANK</option>
    <option>BCR</option><option>BRD</option><option>ING</option>
    <option>GARANTI BANK</option><option>ALPHA BANK</option>
  </select>
  <select id="tipSel">
    <option>IP</option><option>REF IP</option>
    <option>NP</option><option>REF NP</option>
    <option>NC</option><option>CC</option>
  </select>
  <select id="provSel">
    <option>RECOMANDARI</option>
    <option>TEOCREDIT</option>
    <option>AGENT - DAF IMOBILIARE</option>
    <option>TCC - ADAMA</option>
  </select>

  <button id="addBtn" class="green">Adaugă credit</button>
  <input type="file" id="file" accept=".csv">
  <button id="loadCSV" class="green">Încarcă CSV</button>
  <button id="expCSV">Exportă CSV</button>
  <button id="expXLSX">Exportă XLSX</button>
</div>

<table id="tbl">
  <thead>
   <tr><th>#</th><th>Nume</th><th>Banca</th><th>Tip</th><th>Sumă</th><th>Provider</th><th>Proc.</th><th>Comision</th><th></th></tr>
  </thead>
  <tbody></tbody>
  <tfoot>
   <tr><td colspan="7" class="right"><b>Total câştig</b></td><td id="tot" class="right"></td><td></td></tr>
  </tfoot>
</table>

<pre id="rezumat" style="font-size:.8rem"></pre>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
<script>
/* === praguri Cat 1/3 === */
const PRAGURI = {
  BCR:[[0,800000,0.008],[800001,1600000,0.009],[1600001,2400000,0.010],
      [2400001,5_000_000,0.012],[5_000_001,50_000_000,0.014],[50_000_001,Infinity,0.018]],
  FIRSTBANK:[[0,Infinity,0.008]],
  UNICREDITBANK:[[0,800000,0.008],[800001,Infinity,0.009]],
  RAIFFEISENBANK:[[0,800000,0.008],[800001,Infinity,0.009]],
  ING:[[0,1_600_000,0.008],[1_600_001,Infinity,0.009]],
  GARANTIBANK:[[0,Infinity,0.008]],
  ALPHABANK:[[0,800000,0.008],[800001,1_600_000,0.009],[1_600_001,Infinity,0.010]],
  BRD:[[0,Infinity,0.008]]
};
/* alias (toUpperCase, fără spaţii) -> cheie */
const BANK_ALIAS={
 "FIRSTBANK":"FIRSTBANK",
 "FIRST":"FIRSTBANK",
 "UNICREDITBANK":"UNICREDITBANK","UNICREDIT":"UNICREDITBANK",
 "RAIFFEISENBANK":"RAIFFEISENBANK","RAIFFEISEN":"RAIFFEISENBANK",
 "GARANTIBANK":"GARANTIBANK","GARANTI":"GARANTIBANK",
 "ALPHABANK":"ALPHABANK","ALPHA":"ALPHABANK",
 "BRD":"BRD","BCR":"BCR","ING":"ING","INGBANK":"ING"
};
/* Cat 2 fix 0,4 % */
const CAT2_PROC = 0.004;

/* ===== helpers ===== */
const $=s=>document.querySelector(s);
const rows=[];
const tbody=$("#tbl tbody");
const fmt=n=>n.toLocaleString("ro-RO",{maximumFractionDigits:2});
const clean=s=>s.replace(/^[\s"'[\]]+|[\s"'[\]]+$/g,"").trim();
const canon=b=>BANK_ALIAS[ clean(b).toUpperCase().replace(/\s+/g,"") ]||"";
const providerCat=p=>
  p.startsWith("TEOCREDIT")||p.startsWith("TCC -")?2 : p.startsWith("AGENT -")?3 :1;

/* prag pt bancă */
function pragBank(key,sum){
 const arr=PRAGURI[key]||[[0,Infinity,0]];
 return (arr.find(([mn,mx])=>sum>=mn&&sum<=mx)||[0,0,0])[2];
}

/* ===== render ===== */
function render(){
 /* sume Cat1+3 pe bancă */
 const bankSum={};
 rows.forEach(r=>{
   if(providerCat(r.prov)!==2){
      bankSum[r.bKey]=(bankSum[r.bKey]||0)+r.suma;
   }
 });
 /* calc proc+com */
 let total=0;
 rows.forEach(r=>{
   let p=0;
   const cat=providerCat(r.prov);
   if(r.tip.startsWith("NP")){
       p = cat===2?0.01 : cat===3?0.012 : 0.008;
   }else{
       if(cat===2)      p=CAT2_PROC;
       else if(cat===3) p=pragBank(r.bKey,bankSum[r.bKey])/2;
       else             p=pragBank(r.bKey,bankSum[r.bKey]);
   }
   r.proc=p; r.com=r.suma*p; total+=r.com;
 });

 /* tabel */
 tbody.innerHTML="";
 rows.forEach((r,i)=>{
  const tr=document.createElement("tr");
  tr.innerHTML=`<td>${i+1}</td><td>${r.nume}</td><td>${r.banca}</td>
  <td>${r.tip}</td><td class="right">${fmt(r.suma)}</td><td>${r.prov}</td>
  <td class="right">${(r.proc*100).toFixed(2)}%</td>
  <td class="right">${fmt(r.com)} RON</td>
  <td><button class="del" data-i=${i}>x</button></td>`;
  tbody.appendChild(tr);
 });
 $("#tot").textContent = fmt(total);

 /* rezumat */
 let rez=""; Object.entries(bankSum).forEach(([k,s])=>{
   rez += `${k.replace(/BANK$/,"")}: total Cat1+3 = ${fmt(s)} RON → prag ${(pragBank(k,s)*100).toFixed(2)}%\n`;
 });
 $("#rezumat").textContent=rez;
}
document.addEventListener("click",e=>{
 if(e.target.classList.contains("del")){rows.splice(+e.target.dataset.i,1);render();}
});
$("#addBtn").onclick=()=>{
 const suma=+$("#suma").value; if(!suma)return;
 rows.push({
   nume:$("#client").value||"N/A",
   banca:$("#bancaSel").value,
   bKey:canon($("#bancaSel").value),
   tip:$("#tipSel").value,
   suma,
   prov:$("#provSel").value
 }); render();
};
$("#calcBtn").onclick=render;

/* ===== CSV ===== */
function csvRows(txt){
 const out=[]; txt.split(/\r?\n/).forEach((l,i)=>{
  if(!l.trim())return;
  const [n,b,t,s,p]=l.split(",");
  if(i===0 && l.toLowerCase().includes("lastname")) return; // skip header fals
  const suma=parseFloat(s.replace(/\./g,"").replace(",","."));
  if(!suma)return;
  out.push({nume:clean(n)||"N/A",banca:clean(b),bKey:canon(b),
            tip:clean(t),suma,prov:clean(p)});
 });
 return out;
}
$("#loadCSV").onclick=()=>{
 const f=$("#file").files[0]; if(!f)return;
 const fr=new FileReader();
 fr.onload=e=>{ rows.length=0; rows.push(...csvRows(e.target.result)); render(); };
 fr.readAsText(f);
};
/* export */
$("#expCSV").onclick=()=>{
 const csv="Nume,Banca,Tip,Suma,Provider\n"+
           rows.map(r=>[r.nume,r.banca,r.tip,r.suma,r.prov].join(",")).join("\n");
 const a=Object.assign(document.createElement("a"),{href:URL.createObjectURL(new Blob([csv])),download:"comisioane.csv"});
 a.click(); URL.revokeObjectURL(a.href);
};
$("#expXLSX").onclick=()=>{
 if(typeof XLSX==="undefined"){alert("SheetJS nu e disponibil");return;}
 const ws=XLSX.utils.json_to_sheet(rows);
 const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Borderou");
 XLSX.writeFile(wb,"comisioane.xlsx");
};
</script>
</body>
</html>
