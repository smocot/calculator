<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="utf-8">
<title>Calculator Comision</title>
<style>
body{font-family:sans-serif;margin:0 8px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #388e3c;padding:4px;font-size:.88rem}
th{background:#388e3c;color:#fff;text-align:left}
tbody tr:nth-child(even){background:#f8fff8}
button{cursor:pointer}
</style>
</head>
<body>

<!---------- Header inputs ---------->
<input  id="agent" placeholder="Nume agent">
<input  id="luna"  placeholder="Luna (AAAA-LL)">
<input  id="nume"  placeholder="Nume client">
<input  type="file" id="f"  >
<button id="incarca">Încarcă CSV</button>
<button id="exportCsv">Exportă CSV</button>
<button id="exportXlsx">Exportă XLSX</button>
<br><br>

<!---------- Hidden selects + adăugare manuală (rămân aici pt. completare rapidă) ---------->
<input id="suma"  placeholder="Sumă" size="6">
<select id="banca">
 <option>BCR</option><option>BRD</option><option>ING</option><option>UNICREDIT</option>
 <option>RAIFFEISEN</option><option>FIRST BANK</option><option>ALPHA</option>
</select>
<select id="tip"><option>IP</option><option>REF IP</option><option>NP</option><option>REF NP</option></select>
<select id="prov"><option>RECOMANDARI</option><option>TEOCREDIT</option><option>AGENT - XXX</option></select>
<button id="add">Adaugă credit</button>
<button id="calc">Calculează</button>

<!---------- Tabel rezultate ---------->
<table id="tbl"><thead>
<tr><th>#</th><th>Nume</th><th>Banca</th><th>Tip</th><th>Sumă</th>
    <th>Provider</th><th>Proc.</th><th>Comision</th><th></th></tr>
</thead><tbody></tbody>
<tfoot><tr><td colspan="7" style="text-align:right;font-weight:700">Total câștig</td>
         <td id="tot"></td><td></td></tr></tfoot>
</table>

<pre id="rez"></pre>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
<script>
const rows=[], tb=document.querySelector('#tbl tbody'), tot=document.querySelector('#tot'),
      OUT=document.querySelector('#rez');

/* praguri Cat 1 & 3 -- se pot extinde la nevoie */
const PRAG={BCR:[.008,.009,.010,.012], ING:[.008,.009],
  UNICREDIT:[.008,.009], RAIFFEISEN:[.008,.009], FIRST:[.008],
  ALPHA:[.008,.009,.010], BRD:[.008]};

/* utility – “descuie” valori \""…\"" din Excel */
const clean=s=>{
  s=s.trim();
  if(s.startsWith('["')&&s.endsWith('"]')){try{return JSON.parse(s)[0]}catch{}}
  return s.replace(/^"+|"+$/g,'');
};

/* adaugă în memorie + re-render */
function add(r){rows.push(r);render()}

/* ----- CSV load ----- */
document.getElementById('incarca').onclick=()=>{
  const f=document.getElementById('f').files[0]; if(!f)return;
  f.text().then(t=>{
    t.split(/\r?\n/).forEach(l=>{
      if(!l.trim())return;
      const[a,b,c,d,e]=l.split(',');
      if(b&&d&&!isNaN(+d))
        add({nume:clean(a)||'N/A', banca:clean(b), tip:clean(c), suma:+d,
             prov:clean(e)});
    });
  });
};

/* Adăugare manuală (scurt) */
document.getElementById('add').onclick=()=>{
  const suma=+document.getElementById('suma').value||0;
  if(!suma)return;
  add({nume:document.getElementById('nume').value||'N/A',
       banca:document.getElementById('banca').value,
       tip:document.getElementById('tip').value,
       suma, prov:document.getElementById('prov').value});
};

/* calcul procente + total */
function calc(){
  const bankSum={}; // Cat1+3 / bancă
  rows.forEach(r=>{
    if(r.prov!=='TEOCREDIT') bankSum[r.banca]=(bankSum[r.banca]||0)+r.suma;
  });

  let total=0;
  rows.forEach(r=>{
    const b=r.banca.toUpperCase().replace(/[^A-Z ]/g,'').split(' ')[0]; // FIRST, ING…
    const s=bankSum[r.banca]||0, p=PRAG[b]||[{0:.008}], cat1or3=r.prov!=='TEOCREDIT';
    let pct=.004;                                            // default Cat 2
    if(cat1or3){ // Cat1 sau 3
      const steps=PRAG[b]||[];
      if(steps.length==4)      pct= s<8e5?steps[0]:s<1.6e6?steps[1]:s<2.4e6?steps[2]:steps[3];
      else if(steps.length==3) pct= s<8e5?steps[0]:s<1.6e6?steps[1]:steps[2];
      else if(steps.length==2) pct= s<1.6e6?steps[0]:steps[1];
      else                     pct=steps[0];
      if(r.prov.startsWith('AGENT')) pct/=2;                 // Cat3 = jumătate
    }
    r.proc=pct; r.com=r.suma*pct; total+=r.com;
  });

  tot.textContent=total.toLocaleString('ro-RO',{minimumFractionDigits:2});
  OUT.textContent=Object.entries(bankSum).map(([b,s])=>{
    const bkey=b.toUpperCase().replace(/[^A-Z ]/g,'').split(' ')[0], st=PRAG[bkey]||[.008];
    let pr=st[st.length-1]; if(st.length==4)pr= s<8e5?st[0]:s<1.6e6?st[1]:s<2.4e6?st[2]:st[3];
    else if(st.length==3)pr= s<8e5?st[0]:s<1.6e6?st[1]:st[2];
    else if(st.length==2)pr= s<1.6e6?st[0]:st[1];
    return `${b}: total Cat1+3 = ${s.toLocaleString('ro-RO')} RON → prag ${(pr*100).toFixed(2)}%`;
  }).join('\n');
  render();
}

document.getElementById('calc').onclick=calc;

/* tablou => DOM */
function render(){
  tb.innerHTML='';
  rows.forEach((r,i)=>{
    const tr=tb.insertRow(); tr.innerHTML=
     `<td>${i+1}</td><td>${r.nume}</td><td>${r.banca}</td><td>${r.tip}</td>
      <td>${r.suma.toLocaleString('ro-RO')}</td><td>${r.prov}</td>
      <td>${r.proc? (r.proc*100).toFixed(2)+'%':' '}</td>
      <td>${r.com? r.com.toLocaleString('ro-RO',{minimumFractionDigits:2})+' RON':' '}</td>
      <td><button onclick='rows.splice(${i},1);render()'>x</button></td>`;
  });
}

/* Export CSV simplu */
document.getElementById('exportCsv').onclick=()=>{
  const csv=rows.map(r=>[r.nume,r.banca,r.tip,r.suma,r.prov].join(',')).join('\n');
  const a=Object.assign(document.createElement('a'),
      {href:'data:text/csv;charset=utf-8,'+encodeURIComponent(csv),
       download:'comision.csv'}); a.click();
};

/* Export XLSX (sheetjs) */
document.getElementById('exportXlsx').onclick=()=>{
  if(!window.XLSX){alert('SheetJS nu s-a încărcat!');return;}
  const ws=XLSX.utils.json_to_sheet(rows.map(r=>({
    Nume:r.nume,Banca:r.banca,Tip:r.tip,Sumă:r.suma,Provider:r.prov,
    Procent:(r.proc*100).toFixed(2)+'%',Comision:r.com
  })));
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Comision');
  XLSX.writeFile(wb,'comision.xlsx');
};
</script>
</body></html>
