<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="utf-8" />
<title>Calculator Comision</title>
<style>
  body{font-family: Arial, sans-serif;margin:0;padding:1rem}
  table{width:100%;border-collapse:collapse;margin-top:.7rem}
  th,td{border:1px solid #6a8f6a;padding:.35rem;text-align:left;font-size:.85rem}
  th{background:#2e7d32;color:#fff}
  tr:nth-child(even){background:#f6fff6}
  .btn{padding:.35rem .7rem;border:0;border-radius:3px;cursor:pointer;font-size:.8rem}
  .green{background:#2e7d32;color:#fff}
  .orange{background:#f4a300;color:#000}
  .red{background:#d32f2f;color:#fff}
  .muted{font-size:.8rem;margin-top:.5rem;white-space:pre-wrap;font-family:monospace}
</style>
<!-- SheetJS (XLSX) local fallback -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.0/xlsx.full.min.js"
        integrity="sha512-+HkEFJZ8p7z9T1QW2uphuLYYd1DWSRrkZ4kQx6GOBj/L0wYA8JdVwE2bCKVTAjbR3fJWSn4kBgwM4fF5u1cDhw==" 
        crossorigin="anonymous"></script>
</head>
<body>

<!-- bara comenzi -->
<label>Nume agent <input id="agent" style="width:115px"></label>
<label>Luna (AAAA-LL) <input id="luna" style="width:80px"></label>
<label>Nume client <input id="nume" style="width:140px"></label>
<label>Sumă <input id="suma" type="number" style="width:70px" value="0"></label>

<select id="bancaSel">
  <option>BCR</option><option>BRD</option><option>ING</option><option>UNICREDIT</option>
  <option>GARANTI</option><option>FIRST BANK</option><option>PATRIA</option>
  <option>ALPHA</option><option>RAIFFEISEN</option>
</select>
<select id="tipSel"><option>IP</option><option>NP</option><option>REF IP</option><option>REF NP</option></select>
<select id="provSel">
  <option>RECOMANDARI</option>
  <option>TEOCREDIT</option>
  <option>TCC - ADAMA</option>
  <option>TCC - WHITE POINT</option>
  <option>AGENT - DAF IMOBILIARE</option>
  <option>Adama Estate</option>
  <option>aTeoCredit</option>
</select>

<button id="addBtn" class="btn green">Adaugă credit</button>
<button id="calcBtn" class="btn orange">Calculează</button><br>

<input type="file" id="csvFile">
<button id="loadCsv"   class="btn green">Încarcă CSV</button>
<button id="expCsv"    class="btn orange">Exportă CSV</button>
<button id="expXlsx"   class="btn orange">Exportă XLSX</button>

<table id="tbl">
  <thead><tr><th>#</th><th>Nume</th><th>Banca</th><th>Tip</th><th>Suma</th>
             <th>Provider</th><th>Proc.</th><th>Comision</th><th></th></tr></thead>
  <tbody></tbody>
  <tfoot><tr><td colspan="7" style="text-align:right;font-weight:bold">Total câștig</td>
           <td id="total"></td><td></td></tr></tfoot>
</table>

<div id="rez" class="muted"></div>

<script>
const rows = [];

const NP_CAT1 = { // Nevoi personale / Ref NP – Cat 1
  PATRIA:0.012, UNICREDIT:0.02, FIRST:0.02, GARANTI:0.012,
  ING:0.004, BCR:0.002, BRD:0.008, ALPHA:0.01, RAIFFEISEN:0.009
};

function pct(r){
  const bank = r.banca.toUpperCase().replace(/[^A-Z]/g,'');
  const provNorm = r.prov.toUpperCase().trim();

  const isNP = r.tip.startsWith('N'); // NP sau REF NP
  const cat2 = provNorm.startsWith('TEOCREDIT') || provNorm.startsWith('TCC');

  if(cat2) return isNP?0.01:0.004;          // Cat 2
  if(provNorm.startsWith('AGENT')){         // Cat 3 – jumătate din prag Cat1
    const p = pragCat1(bank,r.tip);
    return p/2;
  }
  // altfel Cat 1
  return pragCat1(bank,r.tip);
}
function pragCat1(bank,tip){
  const isNP = tip.startsWith('N');
  if(isNP) return NP_CAT1[bank]??0;
  // ipotecar – praguri pe tranșe
  const total = sumByBankCat13(bank);
  if(bank==='BCR'){
    if(total<=800000) return 0.008;
    if(total<=1600000) return 0.009;
    if(total<=2400000) return 0.010;
    if(total<=5000000) return 0.012;
    if(total<=50000000) return 0.014;
    return 0.018;
  }
  if(bank==='RAIFFEISEN'){
    return total<=800000?0.008:0.009;
  }
  if(bank==='ING'){
    return total<=1600000?0.008:0.009;
  }
  if(bank==='UNICREDIT'){
    return total<=800000?0.008:0.009;
  }
  // default 0.008
  return 0.008;
}
function sumByBankCat13(bank){
  return rows.filter(r=>r.banca.toUpperCase().includes(bank) &&
                        !r.prov.toUpperCase().startsWith('TEOCREDIT') &&
                        !r.prov.toUpperCase().startsWith('TCC'))
             .reduce((s,r)=>s+r.suma,0);
}

function addRow(obj){
  rows.push(obj);
  render();
}
function render(){
  const tb=document.querySelector('#tbl tbody'); tb.innerHTML='';
  let tot=0;
  rows.forEach((r,i)=>{
    r.procent=pct(r); r.comision=r.suma*r.procent;
    tot+=r.comision;
    const tr=tb.insertRow();
    tr.innerHTML=`<td>${i+1}</td><td>${r.nume}</td><td>${r.banca}</td><td>${r.tip}</td>
                  <td>${format(r.suma)}</td><td>${r.prov}</td>
                  <td>${(r.procent*100).toFixed(2)}%</td>
                  <td>${format(r.comision)} RON</td>
                  <td><button class="btn red" onclick="delRow(${i})">x</button></td>`;
  });
  document.getElementById('total').textContent=format(tot);
  // rezumat
  const res=[];
  ;['BCR','FIRST','UNICREDIT','ING','RAIFFEISEN','PATRIA','GARANTI','ALPHA','BRD'].forEach(b=>{
     const s=sumByBankCat13(b);
     if(s) res.push(`${b}: total Cat1+3 = ${format(s)} RON → prag ${(pragCat1(b,'IP')*100).toFixed(2)}%`);
  });
  document.getElementById('rez').textContent=res.join('\n');
}
function delRow(idx){ rows.splice(idx,1);render(); }

function format(x){return x.toLocaleString('ro-RO',{minimumFractionDigits:0,maxFractionDigits:2});}

// === butoane ===
document.getElementById('addBtn').onclick=()=>{
  addRow({
    nume:document.getElementById('nume').value||'N/A',
    banca:document.getElementById('bancaSel').value,
    tip:document.getElementById('tipSel').value,
    suma:+document.getElementById('suma').value||0,
    prov:document.getElementById('provSel').value
  });
};
document.getElementById('calcBtn').onclick=render;

// CSV in
document.getElementById('loadCsv').onclick=()=>{
  const f=document.getElementById('csvFile').files[0];
  if(!f)return;
  f.text().then(t=>{
    t.split(/\r?\n/).forEach(l=>{
      const [n,b,tip,s,prov]=l.split(',');
      if(b&&s && !isNaN(+s))
        addRow({nume:n||'N/A',banca:b.trim(),tip:tip.trim(),suma:+s,prov:prov.trim()});
    });
  });
};
// CSV out
document.getElementById('expCsv').onclick=()=>{
  const lines=rows.map(r=>[r.nume,r.banca,r.tip,r.suma,r.prov,r.procent,r.comision].join(','));
  download('borderou.csv',lines.join('\n'));
};
// XLSX out
document.getElementById('expXlsx').onclick=()=>{
  if(typeof XLSX==='undefined'){alert('SheetJS nu s-a încărcat – rulează offline?');return;}
  const ws=XLSX.utils.json_to_sheet(rows.map(r=>({
    Nume:r.nume,Banca:r.banca,Tip:r.tip,Suma:r.suma,Provider:r.prov,
    Proc:(r.procent*100).toFixed(2)+'%',Comision:r.comision.toFixed(2)
  })));
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Borderou');
  XLSX.writeFile(wb,'borderou.xlsx');
};
function download(fname,txt){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([txt],{type:'text/csv'}));
  a.download=fname; a.click(); URL.revokeObjectURL(a.href);
}
</script>
</body>
</html>
